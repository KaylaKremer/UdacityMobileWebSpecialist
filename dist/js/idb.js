'use strict';

(function () {
	function toArray(arr) {
		return Array.prototype.slice.call(arr);
	}

	function promisifyRequest(request) {
		return new Promise(function (resolve, reject) {
			request.onsuccess = function () {
				resolve(request.result);
			};

			request.onerror = function () {
				reject(request.error);
			};
		});
	}

	function promisifyRequestCall(obj, method, args) {
		var request;
		var p = new Promise(function (resolve, reject) {
			request = obj[method].apply(obj, args);
			promisifyRequest(request).then(resolve, reject);
		});

		p.request = request;
		return p;
	}

	function promisifyCursorRequestCall(obj, method, args) {
		var p = promisifyRequestCall(obj, method, args);
		return p.then(function (value) {
			if (!value) return;
			return new Cursor(value, p.request);
		});
	}

	function proxyProperties(ProxyClass, targetProp, properties) {
		properties.forEach(function (prop) {
			Object.defineProperty(ProxyClass.prototype, prop, {
				get: function get() {
					return this[targetProp][prop];
				},
				set: function set(val) {
					this[targetProp][prop] = val;
				}
			});
		});
	}

	function proxyRequestMethods(ProxyClass, targetProp, Constructor, properties) {
		properties.forEach(function (prop) {
			if (!(prop in Constructor.prototype)) return;
			ProxyClass.prototype[prop] = function () {
				return promisifyRequestCall(this[targetProp], prop, arguments);
			};
		});
	}

	function proxyMethods(ProxyClass, targetProp, Constructor, properties) {
		properties.forEach(function (prop) {
			if (!(prop in Constructor.prototype)) return;
			ProxyClass.prototype[prop] = function () {
				return this[targetProp][prop].apply(this[targetProp], arguments);
			};
		});
	}

	function proxyCursorRequestMethods(ProxyClass, targetProp, Constructor, properties) {
		properties.forEach(function (prop) {
			if (!(prop in Constructor.prototype)) return;
			ProxyClass.prototype[prop] = function () {
				return promisifyCursorRequestCall(this[targetProp], prop, arguments);
			};
		});
	}

	function Index(index) {
		this._index = index;
	}

	proxyProperties(Index, '_index', ['name', 'keyPath', 'multiEntry', 'unique']);

	proxyRequestMethods(Index, '_index', IDBIndex, ['get', 'getKey', 'getAll', 'getAllKeys', 'count']);

	proxyCursorRequestMethods(Index, '_index', IDBIndex, ['openCursor', 'openKeyCursor']);

	function Cursor(cursor, request) {
		this._cursor = cursor;
		this._request = request;
	}

	proxyProperties(Cursor, '_cursor', ['direction', 'key', 'primaryKey', 'value']);

	proxyRequestMethods(Cursor, '_cursor', IDBCursor, ['update', 'delete']);

	// proxy 'next' methods
	['advance', 'continue', 'continuePrimaryKey'].forEach(function (methodName) {
		if (!(methodName in IDBCursor.prototype)) return;
		Cursor.prototype[methodName] = function () {
			var cursor = this;
			var args = arguments;
			return Promise.resolve().then(function () {
				cursor._cursor[methodName].apply(cursor._cursor, args);
				return promisifyRequest(cursor._request).then(function (value) {
					if (!value) return;
					return new Cursor(value, cursor._request);
				});
			});
		};
	});

	function ObjectStore(store) {
		this._store = store;
	}

	ObjectStore.prototype.createIndex = function () {
		return new Index(this._store.createIndex.apply(this._store, arguments));
	};

	ObjectStore.prototype.index = function () {
		return new Index(this._store.index.apply(this._store, arguments));
	};

	proxyProperties(ObjectStore, '_store', ['name', 'keyPath', 'indexNames', 'autoIncrement']);

	proxyRequestMethods(ObjectStore, '_store', IDBObjectStore, ['put', 'add', 'delete', 'clear', 'get', 'getAll', 'getKey', 'getAllKeys', 'count']);

	proxyCursorRequestMethods(ObjectStore, '_store', IDBObjectStore, ['openCursor', 'openKeyCursor']);

	proxyMethods(ObjectStore, '_store', IDBObjectStore, ['deleteIndex']);

	function Transaction(idbTransaction) {
		this._tx = idbTransaction;
		this.complete = new Promise(function (resolve, reject) {
			idbTransaction.oncomplete = function () {
				resolve();
			};
			idbTransaction.onerror = function () {
				reject(idbTransaction.error);
			};
			idbTransaction.onabort = function () {
				reject(idbTransaction.error);
			};
		});
	}

	Transaction.prototype.objectStore = function () {
		return new ObjectStore(this._tx.objectStore.apply(this._tx, arguments));
	};

	proxyProperties(Transaction, '_tx', ['objectStoreNames', 'mode']);

	proxyMethods(Transaction, '_tx', IDBTransaction, ['abort']);

	function UpgradeDB(db, oldVersion, transaction) {
		this._db = db;
		this.oldVersion = oldVersion;
		this.transaction = new Transaction(transaction);
	}

	UpgradeDB.prototype.createObjectStore = function () {
		return new ObjectStore(this._db.createObjectStore.apply(this._db, arguments));
	};

	proxyProperties(UpgradeDB, '_db', ['name', 'version', 'objectStoreNames']);

	proxyMethods(UpgradeDB, '_db', IDBDatabase, ['deleteObjectStore', 'close']);

	function DB(db) {
		this._db = db;
	}

	DB.prototype.transaction = function () {
		return new Transaction(this._db.transaction.apply(this._db, arguments));
	};

	proxyProperties(DB, '_db', ['name', 'version', 'objectStoreNames']);

	proxyMethods(DB, '_db', IDBDatabase, ['close']);

	// Add cursor iterators
	// TODO: remove this once browsers do the right thing with promises
	['openCursor', 'openKeyCursor'].forEach(function (funcName) {
		[ObjectStore, Index].forEach(function (Constructor) {
			// Don't create iterateKeyCursor if openKeyCursor doesn't exist.
			if (!(funcName in Constructor.prototype)) return;

			Constructor.prototype[funcName.replace('open', 'iterate')] = function () {
				var args = toArray(arguments);
				var callback = args[args.length - 1];
				var nativeObject = this._store || this._index;
				var request = nativeObject[funcName].apply(nativeObject, args.slice(0, -1));
				request.onsuccess = function () {
					callback(request.result);
				};
			};
		});
	});

	// polyfill getAll
	[Index, ObjectStore].forEach(function (Constructor) {
		if (Constructor.prototype.getAll) return;
		Constructor.prototype.getAll = function (query, count) {
			var instance = this;
			var items = [];

			return new Promise(function (resolve) {
				instance.iterateCursor(query, function (cursor) {
					if (!cursor) {
						resolve(items);
						return;
					}
					items.push(cursor.value);

					if (count !== undefined && items.length == count) {
						resolve(items);
						return;
					}
					cursor.continue();
				});
			});
		};
	});

	var exp = {
		open: function open(name, version, upgradeCallback) {
			var p = promisifyRequestCall(indexedDB, 'open', [name, version]);
			var request = p.request;

			if (request) {
				request.onupgradeneeded = function (event) {
					if (upgradeCallback) {
						upgradeCallback(new UpgradeDB(request.result, event.oldVersion, request.transaction));
					}
				};
			}

			return p.then(function (db) {
				return new DB(db);
			});
		},
		delete: function _delete(name) {
			return promisifyRequestCall(indexedDB, 'deleteDatabase', [name]);
		}
	};

	if (typeof module !== 'undefined') {
		module.exports = exp;
		module.exports.default = module.exports;
	} else {
		self.idb = exp;
	}
})();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImlkYi5qcyJdLCJuYW1lcyI6WyJ0b0FycmF5IiwiYXJyIiwiQXJyYXkiLCJwcm90b3R5cGUiLCJzbGljZSIsImNhbGwiLCJwcm9taXNpZnlSZXF1ZXN0IiwicmVxdWVzdCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwib25zdWNjZXNzIiwicmVzdWx0Iiwib25lcnJvciIsImVycm9yIiwicHJvbWlzaWZ5UmVxdWVzdENhbGwiLCJvYmoiLCJtZXRob2QiLCJhcmdzIiwicCIsImFwcGx5IiwidGhlbiIsInByb21pc2lmeUN1cnNvclJlcXVlc3RDYWxsIiwidmFsdWUiLCJDdXJzb3IiLCJwcm94eVByb3BlcnRpZXMiLCJQcm94eUNsYXNzIiwidGFyZ2V0UHJvcCIsInByb3BlcnRpZXMiLCJmb3JFYWNoIiwicHJvcCIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZ2V0Iiwic2V0IiwidmFsIiwicHJveHlSZXF1ZXN0TWV0aG9kcyIsIkNvbnN0cnVjdG9yIiwiYXJndW1lbnRzIiwicHJveHlNZXRob2RzIiwicHJveHlDdXJzb3JSZXF1ZXN0TWV0aG9kcyIsIkluZGV4IiwiaW5kZXgiLCJfaW5kZXgiLCJJREJJbmRleCIsImN1cnNvciIsIl9jdXJzb3IiLCJfcmVxdWVzdCIsIklEQkN1cnNvciIsIm1ldGhvZE5hbWUiLCJPYmplY3RTdG9yZSIsInN0b3JlIiwiX3N0b3JlIiwiY3JlYXRlSW5kZXgiLCJJREJPYmplY3RTdG9yZSIsIlRyYW5zYWN0aW9uIiwiaWRiVHJhbnNhY3Rpb24iLCJfdHgiLCJjb21wbGV0ZSIsIm9uY29tcGxldGUiLCJvbmFib3J0Iiwib2JqZWN0U3RvcmUiLCJJREJUcmFuc2FjdGlvbiIsIlVwZ3JhZGVEQiIsImRiIiwib2xkVmVyc2lvbiIsInRyYW5zYWN0aW9uIiwiX2RiIiwiY3JlYXRlT2JqZWN0U3RvcmUiLCJJREJEYXRhYmFzZSIsIkRCIiwiZnVuY05hbWUiLCJyZXBsYWNlIiwiY2FsbGJhY2siLCJsZW5ndGgiLCJuYXRpdmVPYmplY3QiLCJnZXRBbGwiLCJxdWVyeSIsImNvdW50IiwiaW5zdGFuY2UiLCJpdGVtcyIsIml0ZXJhdGVDdXJzb3IiLCJwdXNoIiwidW5kZWZpbmVkIiwiY29udGludWUiLCJleHAiLCJvcGVuIiwibmFtZSIsInZlcnNpb24iLCJ1cGdyYWRlQ2FsbGJhY2siLCJpbmRleGVkREIiLCJvbnVwZ3JhZGVuZWVkZWQiLCJldmVudCIsImRlbGV0ZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJkZWZhdWx0Iiwic2VsZiIsImlkYiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUMsYUFBVztBQUNYLFVBQVNBLE9BQVQsQ0FBaUJDLEdBQWpCLEVBQXNCO0FBQ3JCLFNBQU9DLE1BQU1DLFNBQU4sQ0FBZ0JDLEtBQWhCLENBQXNCQyxJQUF0QixDQUEyQkosR0FBM0IsQ0FBUDtBQUNBOztBQUVELFVBQVNLLGdCQUFULENBQTBCQyxPQUExQixFQUFtQztBQUNsQyxTQUFPLElBQUlDLE9BQUosQ0FBWSxVQUFTQyxPQUFULEVBQWtCQyxNQUFsQixFQUEwQjtBQUM1Q0gsV0FBUUksU0FBUixHQUFvQixZQUFXO0FBQzlCRixZQUFRRixRQUFRSyxNQUFoQjtBQUNBLElBRkQ7O0FBSUFMLFdBQVFNLE9BQVIsR0FBa0IsWUFBVztBQUM1QkgsV0FBT0gsUUFBUU8sS0FBZjtBQUNBLElBRkQ7QUFHQSxHQVJNLENBQVA7QUFTQTs7QUFFRCxVQUFTQyxvQkFBVCxDQUE4QkMsR0FBOUIsRUFBbUNDLE1BQW5DLEVBQTJDQyxJQUEzQyxFQUFpRDtBQUNoRCxNQUFJWCxPQUFKO0FBQ0EsTUFBSVksSUFBSSxJQUFJWCxPQUFKLENBQVksVUFBU0MsT0FBVCxFQUFrQkMsTUFBbEIsRUFBMEI7QUFDN0NILGFBQVVTLElBQUlDLE1BQUosRUFBWUcsS0FBWixDQUFrQkosR0FBbEIsRUFBdUJFLElBQXZCLENBQVY7QUFDQVosb0JBQWlCQyxPQUFqQixFQUEwQmMsSUFBMUIsQ0FBK0JaLE9BQS9CLEVBQXdDQyxNQUF4QztBQUNBLEdBSE8sQ0FBUjs7QUFL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QSxLQUFJQyxNQUFNO0FBQ1RDLFFBQU0sY0FBU0MsSUFBVCxFQUFlQyxPQUFmLEVBQXdCQyxlQUF4QixFQUF5QztBQUM5QyxPQUFJdEUsSUFBSUoscUJBQXFCMkUsU0FBckIsRUFBZ0MsTUFBaEMsRUFBd0MsQ0FBQ0gsSUFBRCxFQUFPQyxPQUFQLENBQXhDLENBQVI7QUFDQSxPQUFJakYsVUFBVVksRUFBRVosT0FBaEI7O0FBRUEsT0FBSUEsT0FBSixFQUFhO0FBQ1pBLFlBQVFvRixlQUFSLEdBQTBCLFVBQVNDLEtBQVQsRUFBZ0I7QUFDekMsU0FBSUgsZUFBSixFQUFxQjtBQUNwQkEsc0JBQWdCLElBQUkxQixTQUFKLENBQWN4RCxRQUFRSyxNQUF0QixFQUE4QmdGLE1BQU0zQixVQUFwQyxFQUFnRDFELFFBQVEyRCxXQUF4RCxDQUFoQjtBQUNBO0FBQ0QsS0FKRDtBQUtBOztBQUVELFVBQU8vQyxFQUFFRSxJQUFGLENBQU8sVUFBUzJDLEVBQVQsRUFBYTtBQUMxQixXQUFPLElBQUlNLEVBQUosQ0FBT04sRUFBUCxDQUFQO0FBQ0EsSUFGTSxDQUFQO0FBR0EsR0FoQlE7QUFpQlQ2QixVQUFRLGlCQUFTTixJQUFULEVBQWU7QUFDdEIsVUFBT3hFLHFCQUFxQjJFLFNBQXJCLEVBQWdDLGdCQUFoQyxFQUFrRCxDQUFDSCxJQUFELENBQWxELENBQVA7QUFDQTtBQW5CUSxFQUFWOztBQXNCQSxLQUFJLE9BQU9PLE1BQVAsS0FBa0IsV0FBdEIsRUFBbUM7QUFDbENBLFNBQU9DLE9BQVAsR0FBaUJWLEdBQWpCO0FBQ0FTLFNBQU9DLE9BQVAsQ0FBZUMsT0FBZixHQUF5QkYsT0FBT0MsT0FBaEM7QUFDQSxFQUhELE1BSUs7QUFDSkUsT0FBS0MsR0FBTCxHQUFXYixHQUFYO0FBQ0E7QUFDRCxDQXpUQSxHQUFEIiwiZmlsZSI6ImlkYi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuKGZ1bmN0aW9uKCkge1xuXHRmdW5jdGlvbiB0b0FycmF5KGFycikge1xuXHRcdHJldHVybiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcnIpO1xuXHR9XG5cblx0ZnVuY3Rpb24gcHJvbWlzaWZ5UmVxdWVzdChyZXF1ZXN0KSB7XG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuXHRcdFx0cmVxdWVzdC5vbnN1Y2Nlc3MgPSBmdW5jdGlvbigpIHtcblx0XHRcdFx0cmVzb2x2ZShyZXF1ZXN0LnJlc3VsdCk7XG5cdFx0XHR9O1xuXG5cdFx0XHRyZXF1ZXN0Lm9uZXJyb3IgPSBmdW5jdGlvbigpIHtcblx0XHRcdFx0cmVqZWN0KHJlcXVlc3QuZXJyb3IpO1xuXHRcdFx0fTtcblx0XHR9KTtcblx0fVxuXG5cdGZ1bmN0aW9uIHByb21pc2lmeVJlcXVlc3RDYWxsKG9iaiwgbWV0aG9kLCBhcmdzKSB7XG5cdFx0dmFyIHJlcXVlc3Q7XG5cdFx0dmFyIHAgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcblx0XHRcdHJlcXVlc3QgPSBvYmpbbWV0aG9kXS5hcHBseShvYmosIGFyZ3MpO1xuXHRcdFx0cHJvbWlzaWZ5UmVxdWVzdChyZXF1ZXN0KS50aGVuKHJlc29sdmUsIHJlamVjdCk7XG5cdFx0fSk7XG5cblx0XHRwLnJlcXVlc3QgPSByZXF1ZXN0O1xuXHRcdHJldHVybiBwO1xuXHR9XG5cblx0ZnVuY3Rpb24gcHJvbWlzaWZ5Q3Vyc29yUmVxdWVzdENhbGwob2JqLCBtZXRob2QsIGFyZ3MpIHtcblx0XHR2YXIgcCA9IHByb21pc2lmeVJlcXVlc3RDYWxsKG9iaiwgbWV0aG9kLCBhcmdzKTtcblx0XHRyZXR1cm4gcC50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7XG5cdFx0XHRpZiAoIXZhbHVlKSByZXR1cm47XG5cdFx0XHRyZXR1cm4gbmV3IEN1cnNvcih2YWx1ZSwgcC5yZXF1ZXN0KTtcblx0XHR9KTtcblx0fVxuXG5cdGZ1bmN0aW9uIHByb3h5UHJvcGVydGllcyhQcm94eUNsYXNzLCB0YXJnZXRQcm9wLCBwcm9wZXJ0aWVzKSB7XG5cdFx0cHJvcGVydGllcy5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHtcblx0XHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShQcm94eUNsYXNzLnByb3RvdHlwZSwgcHJvcCwge1xuXHRcdFx0XHRnZXQ6IGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdHJldHVybiB0aGlzW3RhcmdldFByb3BdW3Byb3BdO1xuXHRcdFx0XHR9LFxuXHRcdFx0XHRzZXQ6IGZ1bmN0aW9uKHZhbCkge1xuXHRcdFx0XHRcdHRoaXNbdGFyZ2V0UHJvcF1bcHJvcF0gPSB2YWw7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdH0pO1xuXHR9XG5cblx0ZnVuY3Rpb24gcHJveHlSZXF1ZXN0TWV0aG9kcyhQcm94eUNsYXNzLCB0YXJnZXRQcm9wLCBDb25zdHJ1Y3RvciwgcHJvcGVydGllcykge1xuXHRcdHByb3BlcnRpZXMuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7XG5cdFx0XHRpZiAoIShwcm9wIGluIENvbnN0cnVjdG9yLnByb3RvdHlwZSkpIHJldHVybjtcblx0XHRcdFByb3h5Q2xhc3MucHJvdG90eXBlW3Byb3BdID0gZnVuY3Rpb24oKSB7XG5cdFx0XHRcdHJldHVybiBwcm9taXNpZnlSZXF1ZXN0Q2FsbCh0aGlzW3RhcmdldFByb3BdLCBwcm9wLCBhcmd1bWVudHMpO1xuXHRcdFx0fTtcblx0XHR9KTtcblx0fVxuXG5cdGZ1bmN0aW9uIHByb3h5TWV0aG9kcyhQcm94eUNsYXNzLCB0YXJnZXRQcm9wLCBDb25zdHJ1Y3RvciwgcHJvcGVydGllcykge1xuXHRcdHByb3BlcnRpZXMuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7XG5cdFx0XHRpZiAoIShwcm9wIGluIENvbnN0cnVjdG9yLnByb3RvdHlwZSkpIHJldHVybjtcblx0XHRcdFByb3h5Q2xhc3MucHJvdG90eXBlW3Byb3BdID0gZnVuY3Rpb24oKSB7XG5cdFx0XHRcdHJldHVybiB0aGlzW3RhcmdldFByb3BdW3Byb3BdLmFwcGx5KHRoaXNbdGFyZ2V0UHJvcF0sIGFyZ3VtZW50cyk7XG5cdFx0XHR9O1xuXHRcdH0pO1xuXHR9XG5cblx0ZnVuY3Rpb24gcHJveHlDdXJzb3JSZXF1ZXN0TWV0aG9kcyhQcm94eUNsYXNzLCB0YXJnZXRQcm9wLCBDb25zdHJ1Y3RvciwgcHJvcGVydGllcykge1xuXHRcdHByb3BlcnRpZXMuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7XG5cdFx0XHRpZiAoIShwcm9wIGluIENvbnN0cnVjdG9yLnByb3RvdHlwZSkpIHJldHVybjtcblx0XHRcdFByb3h5Q2xhc3MucHJvdG90eXBlW3Byb3BdID0gZnVuY3Rpb24oKSB7XG5cdFx0XHRcdHJldHVybiBwcm9taXNpZnlDdXJzb3JSZXF1ZXN0Q2FsbCh0aGlzW3RhcmdldFByb3BdLCBwcm9wLCBhcmd1bWVudHMpO1xuXHRcdFx0fTtcblx0XHR9KTtcblx0fVxuXG5cdGZ1bmN0aW9uIEluZGV4KGluZGV4KSB7XG5cdFx0dGhpcy5faW5kZXggPSBpbmRleDtcblx0fVxuXG5cdHByb3h5UHJvcGVydGllcyhJbmRleCwgJ19pbmRleCcsIFtcblx0XHQnbmFtZScsXG5cdFx0J2tleVBhdGgnLFxuXHRcdCdtdWx0aUVudHJ5Jyxcblx0XHQndW5pcXVlJ1xuXHRdKTtcblxuXHRwcm94eVJlcXVlc3RNZXRob2RzKEluZGV4LCAnX2luZGV4JywgSURCSW5kZXgsIFtcblx0XHQnZ2V0Jyxcblx0XHQnZ2V0S2V5Jyxcblx0XHQnZ2V0QWxsJyxcblx0XHQnZ2V0QWxsS2V5cycsXG5cdFx0J2NvdW50J1xuXHRdKTtcblxuXHRwcm94eUN1cnNvclJlcXVlc3RNZXRob2RzKEluZGV4LCAnX2luZGV4JywgSURCSW5kZXgsIFtcblx0XHQnb3BlbkN1cnNvcicsXG5cdFx0J29wZW5LZXlDdXJzb3InXG5cdF0pO1xuXG5cdGZ1bmN0aW9uIEN1cnNvcihjdXJzb3IsIHJlcXVlc3QpIHtcblx0XHR0aGlzLl9jdXJzb3IgPSBjdXJzb3I7XG5cdFx0dGhpcy5fcmVxdWVzdCA9IHJlcXVlc3Q7XG5cdH1cblxuXHRwcm94eVByb3BlcnRpZXMoQ3Vyc29yLCAnX2N1cnNvcicsIFtcblx0XHQnZGlyZWN0aW9uJyxcblx0XHQna2V5Jyxcblx0XHQncHJpbWFyeUtleScsXG5cdFx0J3ZhbHVlJ1xuXHRdKTtcblxuXHRwcm94eVJlcXVlc3RNZXRob2RzKEN1cnNvciwgJ19jdXJzb3InLCBJREJDdXJzb3IsIFtcblx0XHQndXBkYXRlJyxcblx0XHQnZGVsZXRlJ1xuXHRdKTtcblxuXHQvLyBwcm94eSAnbmV4dCcgbWV0aG9kc1xuXHRbJ2FkdmFuY2UnLCAnY29udGludWUnLCAnY29udGludWVQcmltYXJ5S2V5J10uZm9yRWFjaChmdW5jdGlvbihtZXRob2ROYW1lKSB7XG5cdFx0aWYgKCEobWV0aG9kTmFtZSBpbiBJREJDdXJzb3IucHJvdG90eXBlKSkgcmV0dXJuO1xuXHRcdEN1cnNvci5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHtcblx0XHRcdHZhciBjdXJzb3IgPSB0aGlzO1xuXHRcdFx0dmFyIGFyZ3MgPSBhcmd1bWVudHM7XG5cdFx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbigpIHtcblx0XHRcdFx0Y3Vyc29yLl9jdXJzb3JbbWV0aG9kTmFtZV0uYXBwbHkoY3Vyc29yLl9jdXJzb3IsIGFyZ3MpO1xuXHRcdFx0XHRyZXR1cm4gcHJvbWlzaWZ5UmVxdWVzdChjdXJzb3IuX3JlcXVlc3QpLnRoZW4oZnVuY3Rpb24odmFsdWUpIHtcblx0XHRcdFx0XHRpZiAoIXZhbHVlKSByZXR1cm47XG5cdFx0XHRcdFx0cmV0dXJuIG5ldyBDdXJzb3IodmFsdWUsIGN1cnNvci5fcmVxdWVzdCk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSk7XG5cdFx0fTtcblx0fSk7XG5cblx0ZnVuY3Rpb24gT2JqZWN0U3RvcmUoc3RvcmUpIHtcblx0XHR0aGlzLl9zdG9yZSA9IHN0b3JlO1xuXHR9XG5cblx0T2JqZWN0U3RvcmUucHJvdG90eXBlLmNyZWF0ZUluZGV4ID0gZnVuY3Rpb24oKSB7XG5cdFx0cmV0dXJuIG5ldyBJbmRleCh0aGlzLl9zdG9yZS5jcmVhdGVJbmRleC5hcHBseSh0aGlzLl9zdG9yZSwgYXJndW1lbnRzKSk7XG5cdH07XG5cblx0T2JqZWN0U3RvcmUucHJvdG90eXBlLmluZGV4ID0gZnVuY3Rpb24oKSB7XG5cdFx0cmV0dXJuIG5ldyBJbmRleCh0aGlzLl9zdG9yZS5pbmRleC5hcHBseSh0aGlzLl9zdG9yZSwgYXJndW1lbnRzKSk7XG5cdH07XG5cblx0cHJveHlQcm9wZXJ0aWVzKE9iamVjdFN0b3JlLCAnX3N0b3JlJywgW1xuXHRcdCduYW1lJyxcblx0XHQna2V5UGF0aCcsXG5cdFx0J2luZGV4TmFtZXMnLFxuXHRcdCdhdXRvSW5jcmVtZW50J1xuXHRdKTtcblxuXHRwcm94eVJlcXVlc3RNZXRob2RzKE9iamVjdFN0b3JlLCAnX3N0b3JlJywgSURCT2JqZWN0U3RvcmUsIFtcblx0XHQncHV0Jyxcblx0XHQnYWRkJyxcblx0XHQnZGVsZXRlJyxcblx0XHQnY2xlYXInLFxuXHRcdCdnZXQnLFxuXHRcdCdnZXRBbGwnLFxuXHRcdCdnZXRLZXknLFxuXHRcdCdnZXRBbGxLZXlzJyxcblx0XHQnY291bnQnXG5cdF0pO1xuXG5cdHByb3h5Q3Vyc29yUmVxdWVzdE1ldGhvZHMoT2JqZWN0U3RvcmUsICdfc3RvcmUnLCBJREJPYmplY3RTdG9yZSwgW1xuXHRcdCdvcGVuQ3Vyc29yJyxcblx0XHQnb3BlbktleUN1cnNvcidcblx0XSk7XG5cblx0cHJveHlNZXRob2RzKE9iamVjdFN0b3JlLCAnX3N0b3JlJywgSURCT2JqZWN0U3RvcmUsIFtcblx0XHQnZGVsZXRlSW5kZXgnXG5cdF0pO1xuXG5cdGZ1bmN0aW9uIFRyYW5zYWN0aW9uKGlkYlRyYW5zYWN0aW9uKSB7XG5cdFx0dGhpcy5fdHggPSBpZGJUcmFuc2FjdGlvbjtcblx0XHR0aGlzLmNvbXBsZXRlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG5cdFx0XHRpZGJUcmFuc2FjdGlvbi5vbmNvbXBsZXRlID0gZnVuY3Rpb24oKSB7XG5cdFx0XHRcdHJlc29sdmUoKTtcblx0XHRcdH07XG5cdFx0XHRpZGJUcmFuc2FjdGlvbi5vbmVycm9yID0gZnVuY3Rpb24oKSB7XG5cdFx0XHRcdHJlamVjdChpZGJUcmFuc2FjdGlvbi5lcnJvcik7XG5cdFx0XHR9O1xuXHRcdFx0aWRiVHJhbnNhY3Rpb24ub25hYm9ydCA9IGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRyZWplY3QoaWRiVHJhbnNhY3Rpb24uZXJyb3IpO1xuXHRcdFx0fTtcblx0XHR9KTtcblx0fVxuXG5cdFRyYW5zYWN0aW9uLnByb3RvdHlwZS5vYmplY3RTdG9yZSA9IGZ1bmN0aW9uKCkge1xuXHRcdHJldHVybiBuZXcgT2JqZWN0U3RvcmUodGhpcy5fdHgub2JqZWN0U3RvcmUuYXBwbHkodGhpcy5fdHgsIGFyZ3VtZW50cykpO1xuXHR9O1xuXG5cdHByb3h5UHJvcGVydGllcyhUcmFuc2FjdGlvbiwgJ190eCcsIFtcblx0XHQnb2JqZWN0U3RvcmVOYW1lcycsXG5cdFx0J21vZGUnXG5cdF0pO1xuXG5cdHByb3h5TWV0aG9kcyhUcmFuc2FjdGlvbiwgJ190eCcsIElEQlRyYW5zYWN0aW9uLCBbXG5cdFx0J2Fib3J0J1xuXHRdKTtcblxuXHRmdW5jdGlvbiBVcGdyYWRlREIoZGIsIG9sZFZlcnNpb24sIHRyYW5zYWN0aW9uKSB7XG5cdFx0dGhpcy5fZGIgPSBkYjtcblx0XHR0aGlzLm9sZFZlcnNpb24gPSBvbGRWZXJzaW9uO1xuXHRcdHRoaXMudHJhbnNhY3Rpb24gPSBuZXcgVHJhbnNhY3Rpb24odHJhbnNhY3Rpb24pO1xuXHR9XG5cblx0VXBncmFkZURCLnByb3RvdHlwZS5jcmVhdGVPYmplY3RTdG9yZSA9IGZ1bmN0aW9uKCkge1xuXHRcdHJldHVybiBuZXcgT2JqZWN0U3RvcmUodGhpcy5fZGIuY3JlYXRlT2JqZWN0U3RvcmUuYXBwbHkodGhpcy5fZGIsIGFyZ3VtZW50cykpO1xuXHR9O1xuXG5cdHByb3h5UHJvcGVydGllcyhVcGdyYWRlREIsICdfZGInLCBbXG5cdFx0J25hbWUnLFxuXHRcdCd2ZXJzaW9uJyxcblx0XHQnb2JqZWN0U3RvcmVOYW1lcydcblx0XSk7XG5cblx0cHJveHlNZXRob2RzKFVwZ3JhZGVEQiwgJ19kYicsIElEQkRhdGFiYXNlLCBbXG5cdFx0J2RlbGV0ZU9iamVjdFN0b3JlJyxcblx0XHQnY2xvc2UnXG5cdF0pO1xuXG5cdGZ1bmN0aW9uIERCKGRiKSB7XG5cdFx0dGhpcy5fZGIgPSBkYjtcblx0fVxuXG5cdERCLnByb3RvdHlwZS50cmFuc2FjdGlvbiA9IGZ1bmN0aW9uKCkge1xuXHRcdHJldHVybiBuZXcgVHJhbnNhY3Rpb24odGhpcy5fZGIudHJhbnNhY3Rpb24uYXBwbHkodGhpcy5fZGIsIGFyZ3VtZW50cykpO1xuXHR9O1xuXG5cdHByb3h5UHJvcGVydGllcyhEQiwgJ19kYicsIFtcblx0XHQnbmFtZScsXG5cdFx0J3ZlcnNpb24nLFxuXHRcdCdvYmplY3RTdG9yZU5hbWVzJ1xuXHRdKTtcblxuXHRwcm94eU1ldGhvZHMoREIsICdfZGInLCBJREJEYXRhYmFzZSwgW1xuXHRcdCdjbG9zZSdcblx0XSk7XG5cblx0Ly8gQWRkIGN1cnNvciBpdGVyYXRvcnNcblx0Ly8gVE9ETzogcmVtb3ZlIHRoaXMgb25jZSBicm93c2VycyBkbyB0aGUgcmlnaHQgdGhpbmcgd2l0aCBwcm9taXNlc1xuXHRbJ29wZW5DdXJzb3InLCAnb3BlbktleUN1cnNvciddLmZvckVhY2goZnVuY3Rpb24oZnVuY05hbWUpIHtcblx0XHRbT2JqZWN0U3RvcmUsIEluZGV4XS5mb3JFYWNoKGZ1bmN0aW9uKENvbnN0cnVjdG9yKSB7XG5cdFx0XHQvLyBEb24ndCBjcmVhdGUgaXRlcmF0ZUtleUN1cnNvciBpZiBvcGVuS2V5Q3Vyc29yIGRvZXNuJ3QgZXhpc3QuXG5cdFx0XHRpZiAoIShmdW5jTmFtZSBpbiBDb25zdHJ1Y3Rvci5wcm90b3R5cGUpKSByZXR1cm47XG5cblx0XHRcdENvbnN0cnVjdG9yLnByb3RvdHlwZVtmdW5jTmFtZS5yZXBsYWNlKCdvcGVuJywgJ2l0ZXJhdGUnKV0gPSBmdW5jdGlvbigpIHtcblx0XHRcdFx0dmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyk7XG5cdFx0XHRcdHZhciBjYWxsYmFjayA9IGFyZ3NbYXJncy5sZW5ndGggLSAxXTtcblx0XHRcdFx0dmFyIG5hdGl2ZU9iamVjdCA9IHRoaXMuX3N0b3JlIHx8IHRoaXMuX2luZGV4O1xuXHRcdFx0XHR2YXIgcmVxdWVzdCA9IG5hdGl2ZU9iamVjdFtmdW5jTmFtZV0uYXBwbHkobmF0aXZlT2JqZWN0LCBhcmdzLnNsaWNlKDAsIC0xKSk7XG5cdFx0XHRcdHJlcXVlc3Qub25zdWNjZXNzID0gZnVuY3Rpb24oKSB7XG5cdFx0XHRcdFx0Y2FsbGJhY2socmVxdWVzdC5yZXN1bHQpO1xuXHRcdFx0XHR9O1xuXHRcdFx0fTtcblx0XHR9KTtcblx0fSk7XG5cblx0Ly8gcG9seWZpbGwgZ2V0QWxsXG5cdFtJbmRleCwgT2JqZWN0U3RvcmVdLmZvckVhY2goZnVuY3Rpb24oQ29uc3RydWN0b3IpIHtcblx0XHRpZiAoQ29uc3RydWN0b3IucHJvdG90eXBlLmdldEFsbCkgcmV0dXJuO1xuXHRcdENvbnN0cnVjdG9yLnByb3RvdHlwZS5nZXRBbGwgPSBmdW5jdGlvbihxdWVyeSwgY291bnQpIHtcblx0XHRcdHZhciBpbnN0YW5jZSA9IHRoaXM7XG5cdFx0XHR2YXIgaXRlbXMgPSBbXTtcblxuXHRcdFx0cmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUpIHtcblx0XHRcdFx0aW5zdGFuY2UuaXRlcmF0ZUN1cnNvcihxdWVyeSwgZnVuY3Rpb24oY3Vyc29yKSB7XG5cdFx0XHRcdFx0aWYgKCFjdXJzb3IpIHtcblx0XHRcdFx0XHRcdHJlc29sdmUoaXRlbXMpO1xuXHRcdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRpdGVtcy5wdXNoKGN1cnNvci52YWx1ZSk7XG5cblx0XHRcdFx0XHRpZiAoY291bnQgIT09IHVuZGVmaW5lZCAmJiBpdGVtcy5sZW5ndGggPT0gY291bnQpIHtcblx0XHRcdFx0XHRcdHJlc29sdmUoaXRlbXMpO1xuXHRcdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRjdXJzb3IuY29udGludWUoKTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9KTtcblx0XHR9O1xuXHR9KTtcblxuXHR2YXIgZXhwID0ge1xuXHRcdG9wZW46IGZ1bmN0aW9uKG5hbWUsIHZlcnNpb24sIHVwZ3JhZGVDYWxsYmFjaykge1xuXHRcdFx0dmFyIHAgPSBwcm9taXNpZnlSZXF1ZXN0Q2FsbChpbmRleGVkREIsICdvcGVuJywgW25hbWUsIHZlcnNpb25dKTtcblx0XHRcdHZhciByZXF1ZXN0ID0gcC5yZXF1ZXN0O1xuXG5cdFx0XHRpZiAocmVxdWVzdCkge1xuXHRcdFx0XHRyZXF1ZXN0Lm9udXBncmFkZW5lZWRlZCA9IGZ1bmN0aW9uKGV2ZW50KSB7XG5cdFx0XHRcdFx0aWYgKHVwZ3JhZGVDYWxsYmFjaykge1xuXHRcdFx0XHRcdFx0dXBncmFkZUNhbGxiYWNrKG5ldyBVcGdyYWRlREIocmVxdWVzdC5yZXN1bHQsIGV2ZW50Lm9sZFZlcnNpb24sIHJlcXVlc3QudHJhbnNhY3Rpb24pKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH07XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBwLnRoZW4oZnVuY3Rpb24oZGIpIHtcblx0XHRcdFx0cmV0dXJuIG5ldyBEQihkYik7XG5cdFx0XHR9KTtcblx0XHR9LFxuXHRcdGRlbGV0ZTogZnVuY3Rpb24obmFtZSkge1xuXHRcdFx0cmV0dXJuIHByb21pc2lmeVJlcXVlc3RDYWxsKGluZGV4ZWREQiwgJ2RlbGV0ZURhdGFiYXNlJywgW25hbWVdKTtcblx0XHR9XG5cdH07XG5cblx0aWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnKSB7XG5cdFx0bW9kdWxlLmV4cG9ydHMgPSBleHA7XG5cdFx0bW9kdWxlLmV4cG9ydHMuZGVmYXVsdCA9IG1vZHVsZS5leHBvcnRzO1xuXHR9XG5cdGVsc2Uge1xuXHRcdHNlbGYuaWRiID0gZXhwO1xuXHR9XG59KCkpOyJdfQ==
