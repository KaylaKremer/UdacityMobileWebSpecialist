'use strict';

var restaurants = void 0,
    neighborhoods = void 0,
    cuisines = void 0,
    map = void 0;
var liveMap = false;
var initLoad = true;
var markers = [];
var offlineFavoriteCounter = 0;

/**
 * Fetch neighborhoods and cuisines as soon as the page is loaded.
 */
document.addEventListener('DOMContentLoaded', function (event) {
	fetchNeighborhoods();
	fetchCuisines();
});

/**
 * Fetch all neighborhoods and set their HTML.
 */
var fetchNeighborhoods = function fetchNeighborhoods() {
	DBHelper.fetchNeighborhoods(function (error, neighborhoods) {
		if (error) {
			// Got an error
			console.error(error);
		} else {
			self.neighborhoods = neighborhoods;
			fillNeighborhoodsHTML();
		}
	});
};

/**
 * Set neighborhoods HTML.
 */
var fillNeighborhoodsHTML = function fillNeighborhoodsHTML() {
	var neighborhoods = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.neighborhoods;

	var select = document.getElementById('neighborhoods-select');
	neighborhoods.forEach(function (neighborhood) {
		var option = document.createElement('option');
		option.innerHTML = neighborhood;
		option.value = neighborhood;
		select.append(option);
	});
};

/**
 * Fetch all cuisines and set their HTML.
 */
var fetchCuisines = function fetchCuisines() {
	DBHelper.fetchCuisines(function (error, cuisines) {
		if (error) {
			// Got an error!
			console.error(error);
		} else {
			self.cuisines = cuisines;
			fillCuisinesHTML();
		}
	});
};

/**
 * Set cuisines HTML.
 */
var fillCuisinesHTML = function fillCuisinesHTML() {
	var cuisines = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.cuisines;

	var select = document.getElementById('cuisines-select');

	cuisines.forEach(function (cuisine) {
		var option = document.createElement('option');
		option.innerHTML = cuisine;
		option.value = cuisine;
		select.append(option);
	});
};

/**
 * Initialize Google map, called from HTML.
 */
window.initMap = function () {
	updateRestaurants();
};

/**
 * Update page and map for current restaurants.
 */
var updateRestaurants = function updateRestaurants() {
	var cSelect = document.getElementById('cuisines-select');
	var nSelect = document.getElementById('neighborhoods-select');

	var cIndex = cSelect.selectedIndex;
	var nIndex = nSelect.selectedIndex;

	var cuisine = cSelect[cIndex].value;
	var neighborhood = nSelect[nIndex].value;

	DBHelper.fetchRestaurantByCuisineAndNeighborhood(cuisine, neighborhood, function (error, restaurants) {
		if (error) {
			// Got an error!
			console.error(error);
		} else {
			resetRestaurants(restaurants);
			fillRestaurantsHTML();
		}
	});
};

/**
 * Clear current restaurants, their HTML and remove their map markers.
 */
var resetRestaurants = function resetRestaurants(restaurants) {
	// Remove all restaurants
	self.restaurants = [];
	var ul = document.getElementById('restaurants-list');
	ul.innerHTML = '';

	// Remove all map markers
	self.markers.forEach(function (m) {
		return m.setMap(null);
	});
	self.markers = [];
	self.restaurants = restaurants;
};

/**
 * Create all restaurants HTML and add them to the webpage.
 */

/* If a live map isn't already enabled, removes the static map image and replaces it with a live Google Map. */
var getLiveMap = function getLiveMap() {
	updateRestaurants();
	if (liveMap) {
		return;
	} else {
		var staticMapImg = document.getElementById('static-map-img');
		staticMapImg.parentNode.removeChild(staticMapImg);
		var loc = {
			lat: 40.722216,
			lng: -73.987501
		};
		self.map = new google.maps.Map(document.getElementById('map'), {
			zoom: 12,
			center: loc,
			scrollwheel: false
		});
		liveMap = true;
	}
};

var fillRestaurantsHTML = function fillRestaurantsHTML() {
	var restaurants = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.restaurants;

	var ul = document.getElementById('restaurants-list');
	restaurants.forEach(function (restaurant) {
		ul.append(createRestaurantHTML(restaurant));
	});

	/* Loads a static map image if it's the initial page load. Adds a click event listener so that when the user clicks on the map, it removes the static map image and loads a live map in its place. */
	if (initLoad) {
		fetchNeighborhoods();
		fetchCuisines();
		var staticMap = DBHelper.staticImageForMapIndex(self.restaurants);
		var _map = document.getElementById('map');
		var staticMapImg = document.createElement('img');
		staticMapImg.id = 'static-map-img';
		staticMapImg.alt = 'Static Google Maps image';
		staticMapImg.style.width = _map.clientWidth + 'px';
		staticMapImg.style.height = _map.clientHeight + 'px';
		staticMapImg.src = staticMap;
		staticMapImg.addEventListener('click', function () {
			getLiveMap();
		});
		_map.appendChild(staticMapImg);
		initLoad = false;
	} else {
		addMarkersToMap();
	}
};

/**
 * Create restaurant HTML.
 */
var createRestaurantHTML = function createRestaurantHTML(restaurant) {
	/* Lazy loads small or large version of restaurant image based on data-srcset and auto data-sizes. Also dynamically sets alt and title text of the image. */
	var li = document.createElement('li');
	var image = document.createElement('img');
	image.className = 'restaurant-img lazyload';
	image.setAttribute('data-src', DBHelper.smallImageUrlForRestaurant(restaurant) + ' 400w');
	image.setAttribute('data-srcset', DBHelper.smallImageUrlForRestaurant(restaurant) + ' 400w, ' + DBHelper.largeImageUrlForRestaurant(restaurant) + ' 800w');
	image.setAttribute('data-sizes', 'auto');
	image.title = '' + restaurant.name;
	image.alt = restaurant.name + ' in ' + restaurant.neighborhood + ' - ' + restaurant.cuisine_type + ' restaurant';
	li.appendChild(image);

	/* Creates header div to hold name & favorite button. */
	var header = document.createElement('div');
	header.id = "header";
	li.appendChild(header);

	var name = document.createElement('h3');
	name.innerHTML = restaurant.name;
	header.appendChild(name);

	/* Creates favorite button */
	createFavoriteButton(restaurant, header);

	var neighborhood = document.createElement('p');
	neighborhood.innerHTML = restaurant.neighborhood;
	li.appendChild(neighborhood);

	var address = document.createElement('p');
	address.innerHTML = restaurant.address;
	li.appendChild(address);

	/* Creates empty element so flex grow can be applied and create space to vertically align View Details buttons. */
	var empty = document.createElement('p');
	empty.className = 'restaurant-empty';
	li.appendChild(empty);

	var more = document.createElement('a');
	more.innerHTML = 'View Restaurant Details';
	more.href = DBHelper.urlForRestaurant(restaurant);

	/* Dynamically sets title attribute. */
	more.title = restaurant.name + ' - View Restaurant Details';

	/* Sets ARIA attributes to each restaurant link. */
	more.setAttribute('role', 'button');
	more.setAttribute('tabindex', '0');
	more.setAttribute('aria-label', 'View' + restaurant.name + 'Restaurant Details');
	li.appendChild(more);

	return li;
};

/**
 * Creates a favorite button. When clicked, notifies user that restaurant favorite has been added or removed via visual cues and ARIA label changes. Also updates server and IndexedDB with favorite status of the restaurant. If user clicks on favorite button while offline, stores favorite status in local storage and creates an offline label to notify user favorite status will be updated when network connection is reestablished. 
 */
var createFavoriteButton = function createFavoriteButton(restaurant, header) {
	var favoriteButton = document.createElement('button');
	favoriteButton.type = 'button';
	favoriteButton.id = 'favorite-button';
	var restaurantId = restaurant.id;
	var isFavorite = restaurant.is_favorite;
	var noOfflineLabel = true;

	changeFavoriteButton(isFavorite, favoriteButton);

	favoriteButton.addEventListener('click', function () {
		if (!navigator.onLine) {
			if (isFavorite === 'false') {
				isFavorite = 'true';
			} else {
				isFavorite = 'false';
			}
			/* Creates unique id to reference favorite status in local storage. */
			offlineFavoriteCounter++;
			var favoriteId = offlineFavoriteCounter.toString();
			/* Make sure only one offline label is created no matter how many times user clicks on favorite button while offline */
			if (noOfflineLabel) {
				var offlineFavoriteLabel = document.createElement('div');
				offlineFavoriteLabel.classList.add('offline-favorite-label');
				offlineFavoriteLabel.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Offline Mode - Favorite status will submit when network connection is reestablished';
				header.parentNode.insertBefore(offlineFavoriteLabel, header);
				noOfflineLabel = false;
			}
			DBHelper.updateFavorite(favoriteId, restaurantId, isFavorite);
			restaurant.is_favorite = isFavorite;
			changeFavoriteButton(isFavorite, favoriteButton);
			return;
		}
		if (isFavorite === 'false') {
			isFavorite = 'true';
		} else {
			isFavorite = 'false';
		}
		DBHelper.updateFavorite(null, restaurantId, isFavorite);
		restaurant.is_favorite = isFavorite;
		changeFavoriteButton(isFavorite, favoriteButton);
	});
	header.appendChild(favoriteButton);
};

/**
 * Change favorite button to appear on or off with class change.
 */
var changeFavoriteButton = function changeFavoriteButton(isFavorite, favoriteButton) {
	if (isFavorite === 'true') {
		favoriteButton.title = 'Remove from favorites';
		favoriteButton.setAttribute('aria-label', 'Remove from favorites');
		favoriteButton.classList.add('index-favorite-true');
		favoriteButton.classList.remove('index-favorite-false');
		favoriteButton.innerHTML = '<i class="fas fa-heart"></i>';
	} else {
		favoriteButton.title = 'Add to favorites';
		favoriteButton.setAttribute('aria-label', 'Add to favorites');
		favoriteButton.classList.add('index-favorite-false');
		favoriteButton.classList.remove('index-favorite-true');
		favoriteButton.innerHTML = '<i class="far fa-heart"></i>';
	}
};

/**
 * Add markers for current restaurants to the map.
 */
var addMarkersToMap = function addMarkersToMap() {
	var restaurants = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.restaurants;

	restaurants.forEach(function (restaurant) {
		// Add marker to the map
		var marker = DBHelper.mapMarkerForRestaurant(restaurant, self.map);
		google.maps.event.addListener(marker, 'click', function () {
			window.location.href = marker.url;
		});
		self.markers.push(marker);
	});
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsicmVzdGF1cmFudHMiLCJuZWlnaGJvcmhvb2RzIiwiY3Vpc2luZXMiLCJtYXAiLCJsaXZlTWFwIiwiaW5pdExvYWQiLCJtYXJrZXJzIiwib2ZmbGluZUZhdm9yaXRlQ291bnRlciIsImRvY3VtZW50IiwiYWRkRXZlbnRMaXN0ZW5lciIsImV2ZW50IiwiZmV0Y2hOZWlnaGJvcmhvb2RzIiwiZmV0Y2hDdWlzaW5lcyIsIkRCSGVscGVyIiwiZXJyb3IiLCJjb25zb2xlIiwic2VsZiIsImZpbGxOZWlnaGJvcmhvb2RzSFRNTCIsInNlbGVjdCIsImdldEVsZW1lbnRCeUlkIiwiZm9yRWFjaCIsIm9wdGlvbiIsImNyZWF0ZUVsZW1lbnQiLCJpbm5lckhUTUwiLCJuZWlnaGJvcmhvb2QiLCJ2YWx1ZSIsImFwcGVuZCIsImZpbGxDdWlzaW5lc0hUTUwiLCJjdWlzaW5lIiwid2luZG93IiwiaW5pdE1hcCIsInVwZGF0ZVJlc3RhdXJhbnRzIiwiY1NlbGVjdCIsIm5TZWxlY3QiLCJjSW5kZXgiLCJzZWxlY3RlZEluZGV4IiwibkluZGV4IiwiZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lQW5kTmVpZ2hib3Job29kIiwicmVzZXRSZXN0YXVyYW50cyIsImZpbGxSZXN0YXVyYW50c0hUTUwiLCJ1bCIsIm0iLCJzZXRNYXAiLCJnZXRMaXZlTWFwIiwic3RhdGljTWFwSW1nIiwicGFyZW50Tm9kZSIsInJlbW92ZUNoaWxkIiwibG9jIiwibGF0IiwibG5nIiwiZ29vZ2xlIiwibWFwcyIsIk1hcCIsInpvb20iLCJjZW50ZXIiLCJzY3JvbGx3aGVlbCIsImNyZWF0ZVJlc3RhdXJhbnRIVE1MIiwicmVzdGF1cmFudCIsInN0YXRpY01hcCIsInN0YXRpY0ltYWdlRm9yTWFwSW5kZXgiLCJpZCIsImFsdCIsInN0eWxlIiwid2lkdGgiLCJjbGllbnRXaWR0aCIsImhlaWdodCIsImNsaWVudEhlaWdodCIsInNyYyIsImFwcGVuZENoaWxkIiwiYWRkTWFya2Vyc1RvTWFwIiwibGkiLCJpbWFnZSIsImNsYXNzTmFtZSIsInNldEF0dHJpYnV0ZSIsInNtYWxsSW1hZ2VVcmxGb3JSZXN0YXVyYW50IiwibGFyZ2VJbWFnZVVybEZvclJlc3RhdXJhbnQiLCJ0aXRsZSIsIm5hbWUiLCJjdWlzaW5lX3R5cGUiLCJoZWFkZXIiLCJjcmVhdGVGYXZvcml0ZUJ1dHRvbiIsImFkZHJlc3MiLCJlbXB0eSIsIm1vcmUiLCJocmVmIiwidXJsRm9yUmVzdGF1cmFudCIsImZhdm9yaXRlQnV0dG9uIiwidHlwZSIsInJlc3RhdXJhbnRJZCIsImlzRmF2b3JpdGUiLCJpc19mYXZvcml0ZSIsIm5vT2ZmbGluZUxhYmVsIiwiY2hhbmdlRmF2b3JpdGVCdXR0b24iLCJuYXZpZ2F0b3IiLCJvbkxpbmUiLCJmYXZvcml0ZUlkIiwidG9TdHJpbmciLCJvZmZsaW5lRmF2b3JpdGVMYWJlbCIsImNsYXNzTGlzdCIsImFkZCIsImluc2VydEJlZm9yZSIsInVwZGF0ZUZhdm9yaXRlIiwicmVtb3ZlIiwibWFya2VyIiwibWFwTWFya2VyRm9yUmVzdGF1cmFudCIsImFkZExpc3RlbmVyIiwibG9jYXRpb24iLCJ1cmwiLCJwdXNoIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUlBLG9CQUFKO0FBQUEsSUFDQ0Msc0JBREQ7QUFBQSxJQUVDQyxpQkFGRDtBQUFBLElBR0NDLFlBSEQ7QUFJQSxJQUFJQyxVQUFVLEtBQWQ7QUFDQSxJQUFJQyxXQUFXLElBQWY7QUFDQSxJQUFJQyxVQUFVLEVBQWQ7QUFDQSxJQUFJQyx5QkFBeUIsQ0FBN0I7O0FBRUE7OztBQUdBQyxTQUFTQyxnQkFBVCxDQUEwQixrQkFBMUIsRUFBOEMsVUFBQ0MsS0FBRCxFQUFXO0FBQ3hEQztBQUNBQztBQUNBLENBSEQ7O0FBS0E7OztBQUdBLElBQU1ELHFCQUFxQixTQUFyQkEsa0JBQXFCLEdBQU07QUFDaENFLFVBQVNGLGtCQUFULENBQTRCLFVBQUNHLEtBQUQsRUFBUWIsYUFBUixFQUEwQjtBQUNyRCxNQUFJYSxLQUFKLEVBQVc7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QWxCQSxlQUFrQixHQUFvQztBQUFBLEtBQW5DckUsV0FBbUMsdUVBQXJCZ0IsS0FBS2hCLFdBQWdCOztBQUMzREEsYUFBWW9CLE9BQVosQ0FBb0Isc0JBQWM7QUFDakM7QUFDQSxNQUFNbUYsU0FBUzFGLFNBQVMyRixzQkFBVCxDQUFnQy9DLFVBQWhDLEVBQTRDekMsS0FBS2IsR0FBakQsQ0FBZjtBQUNBK0MsU0FBT0MsSUFBUCxDQUFZekMsS0FBWixDQUFrQitGLFdBQWxCLENBQThCRixNQUE5QixFQUFzQyxPQUF0QyxFQUErQyxZQUFNO0FBQ3BEMUUsVUFBTzZFLFFBQVAsQ0FBZ0J0QixJQUFoQixHQUF1Qm1CLE9BQU9JLEdBQTlCO0FBQ0EsR0FGRDtBQUdBM0YsT0FBS1YsT0FBTCxDQUFhc0csSUFBYixDQUFrQkwsTUFBbEI7QUFDQSxFQVBEO0FBUUEsQ0FURCIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsibGV0IHJlc3RhdXJhbnRzLFxuXHRuZWlnaGJvcmhvb2RzLFxuXHRjdWlzaW5lcyxcblx0bWFwO1xubGV0IGxpdmVNYXAgPSBmYWxzZTtcbmxldCBpbml0TG9hZCA9IHRydWU7XG5sZXQgbWFya2VycyA9IFtdO1xubGV0IG9mZmxpbmVGYXZvcml0ZUNvdW50ZXIgPSAwO1xuXG4vKipcbiAqIEZldGNoIG5laWdoYm9yaG9vZHMgYW5kIGN1aXNpbmVzIGFzIHNvb24gYXMgdGhlIHBhZ2UgaXMgbG9hZGVkLlxuICovXG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgKGV2ZW50KSA9PiB7XG5cdGZldGNoTmVpZ2hib3Job29kcygpO1xuXHRmZXRjaEN1aXNpbmVzKCk7XG59KTtcblxuLyoqXG4gKiBGZXRjaCBhbGwgbmVpZ2hib3Job29kcyBhbmQgc2V0IHRoZWlyIEhUTUwuXG4gKi9cbmNvbnN0IGZldGNoTmVpZ2hib3Job29kcyA9ICgpID0+IHtcblx0REJIZWxwZXIuZmV0Y2hOZWlnaGJvcmhvb2RzKChlcnJvciwgbmVpZ2hib3Job29kcykgPT4ge1xuXHRcdGlmIChlcnJvcikgeyBcblx0XHRcdC8vIEdvdCBhbiBlcnJvclxuXHRcdFx0Y29uc29sZS5lcnJvcihlcnJvcik7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHNlbGYubmVpZ2hib3Job29kcyA9IG5laWdoYm9yaG9vZHM7XG5cdFx0XHRmaWxsTmVpZ2hib3Job29kc0hUTUwoKTtcblx0XHR9XG5cdH0pO1xufTtcblxuLyoqXG4gKiBTZXQgbmVpZ2hib3Job29kcyBIVE1MLlxuICovXG5jb25zdCBmaWxsTmVpZ2hib3Job29kc0hUTUwgPSAobmVpZ2hib3Job29kcyA9IHNlbGYubmVpZ2hib3Job29kcykgPT4ge1xuXHRjb25zdCBzZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbmVpZ2hib3Job29kcy1zZWxlY3QnKTtcblx0bmVpZ2hib3Job29kcy5mb3JFYWNoKG5laWdoYm9yaG9vZCA9PiB7XG5cdFx0Y29uc3Qgb3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJyk7XG5cdFx0b3B0aW9uLmlubmVySFRNTCA9IG5laWdoYm9yaG9vZDtcblx0XHRvcHRpb24udmFsdWUgPSBuZWlnaGJvcmhvb2Q7XG5cdFx0c2VsZWN0LmFwcGVuZChvcHRpb24pO1xuXHR9KTtcbn07XG5cbi8qKlxuICogRmV0Y2ggYWxsIGN1aXNpbmVzIGFuZCBzZXQgdGhlaXIgSFRNTC5cbiAqL1xuY29uc3QgZmV0Y2hDdWlzaW5lcyA9ICgpID0+IHtcblx0REJIZWxwZXIuZmV0Y2hDdWlzaW5lcygoZXJyb3IsIGN1aXNpbmVzKSA9PiB7XG5cdFx0aWYgKGVycm9yKSB7IFxuXHRcdFx0Ly8gR290IGFuIGVycm9yIVxuXHRcdFx0Y29uc29sZS5lcnJvcihlcnJvcik7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHNlbGYuY3Vpc2luZXMgPSBjdWlzaW5lcztcblx0XHRcdGZpbGxDdWlzaW5lc0hUTUwoKTtcblx0XHR9XG5cdH0pO1xufTtcblxuLyoqXG4gKiBTZXQgY3Vpc2luZXMgSFRNTC5cbiAqL1xuY29uc3QgZmlsbEN1aXNpbmVzSFRNTCA9IChjdWlzaW5lcyA9IHNlbGYuY3Vpc2luZXMpID0+IHtcblx0Y29uc3Qgc2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2N1aXNpbmVzLXNlbGVjdCcpO1xuXG5cdGN1aXNpbmVzLmZvckVhY2goY3Vpc2luZSA9PiB7XG5cdFx0Y29uc3Qgb3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJyk7XG5cdFx0b3B0aW9uLmlubmVySFRNTCA9IGN1aXNpbmU7XG5cdFx0b3B0aW9uLnZhbHVlID0gY3Vpc2luZTtcblx0XHRzZWxlY3QuYXBwZW5kKG9wdGlvbik7XG5cdH0pO1xufTtcblxuLyoqXG4gKiBJbml0aWFsaXplIEdvb2dsZSBtYXAsIGNhbGxlZCBmcm9tIEhUTUwuXG4gKi9cbndpbmRvdy5pbml0TWFwID0gKCkgPT4ge1xuXHR1cGRhdGVSZXN0YXVyYW50cygpO1xufTtcblxuLyoqXG4gKiBVcGRhdGUgcGFnZSBhbmQgbWFwIGZvciBjdXJyZW50IHJlc3RhdXJhbnRzLlxuICovXG5jb25zdCB1cGRhdGVSZXN0YXVyYW50cyA9ICgpID0+IHtcblx0Y29uc3QgY1NlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdWlzaW5lcy1zZWxlY3QnKTtcblx0Y29uc3QgblNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduZWlnaGJvcmhvb2RzLXNlbGVjdCcpO1xuXG5cdGNvbnN0IGNJbmRleCA9IGNTZWxlY3Quc2VsZWN0ZWRJbmRleDtcblx0Y29uc3QgbkluZGV4ID0gblNlbGVjdC5zZWxlY3RlZEluZGV4O1xuXG5cdGNvbnN0IGN1aXNpbmUgPSBjU2VsZWN0W2NJbmRleF0udmFsdWU7XG5cdGNvbnN0IG5laWdoYm9yaG9vZCA9IG5TZWxlY3RbbkluZGV4XS52YWx1ZTtcblxuXHREQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QoY3Vpc2luZSwgbmVpZ2hib3Job29kLCAoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XG5cdFx0aWYgKGVycm9yKSB7IC8vIEdvdCBhbiBlcnJvciFcblx0XHRcdGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXNldFJlc3RhdXJhbnRzKHJlc3RhdXJhbnRzKTtcblx0XHRcdGZpbGxSZXN0YXVyYW50c0hUTUwoKTtcblx0XHR9XG5cdH0pO1xufTtcblxuLyoqXG4gKiBDbGVhciBjdXJyZW50IHJlc3RhdXJhbnRzLCB0aGVpciBIVE1MIGFuZCByZW1vdmUgdGhlaXIgbWFwIG1hcmtlcnMuXG4gKi9cbmNvbnN0IHJlc2V0UmVzdGF1cmFudHMgPSAocmVzdGF1cmFudHMpID0+IHtcblx0Ly8gUmVtb3ZlIGFsbCByZXN0YXVyYW50c1xuXHRzZWxmLnJlc3RhdXJhbnRzID0gW107XG5cdGNvbnN0IHVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnRzLWxpc3QnKTtcblx0dWwuaW5uZXJIVE1MID0gJyc7XG5cblx0Ly8gUmVtb3ZlIGFsbCBtYXAgbWFya2Vyc1xuXHRzZWxmLm1hcmtlcnMuZm9yRWFjaChtID0+IG0uc2V0TWFwKG51bGwpKTtcblx0c2VsZi5tYXJrZXJzID0gW107XG5cdHNlbGYucmVzdGF1cmFudHMgPSByZXN0YXVyYW50cztcbn07XG5cbi8qKlxuICogQ3JlYXRlIGFsbCByZXN0YXVyYW50cyBIVE1MIGFuZCBhZGQgdGhlbSB0byB0aGUgd2VicGFnZS5cbiAqL1xuXG4vKiBJZiBhIGxpdmUgbWFwIGlzbid0IGFscmVhZHkgZW5hYmxlZCwgcmVtb3ZlcyB0aGUgc3RhdGljIG1hcCBpbWFnZSBhbmQgcmVwbGFjZXMgaXQgd2l0aCBhIGxpdmUgR29vZ2xlIE1hcC4gKi9cbmNvbnN0IGdldExpdmVNYXAgPSAoKSA9PiB7XG5cdHVwZGF0ZVJlc3RhdXJhbnRzKCk7XG5cdGlmKGxpdmVNYXApe1xuXHRcdHJldHVybjtcblx0fSBlbHNlIHtcblx0XHRjb25zdCBzdGF0aWNNYXBJbWcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhdGljLW1hcC1pbWcnKTtcblx0XHRzdGF0aWNNYXBJbWcucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzdGF0aWNNYXBJbWcpO1xuXHRcdGxldCBsb2MgPSB7XG5cdFx0XHRsYXQ6IDQwLjcyMjIxNixcblx0XHRcdGxuZzogLTczLjk4NzUwMVxuXHRcdH07XG5cdFx0c2VsZi5tYXAgPSBuZXcgZ29vZ2xlXG5cdFx0XHQubWFwc1xuXHRcdFx0Lk1hcChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFwJyksIHtcblx0XHRcdFx0em9vbTogMTIsXG5cdFx0XHRcdGNlbnRlcjogbG9jLFxuXHRcdFx0XHRzY3JvbGx3aGVlbDogZmFsc2Vcblx0XHRcdH0pO1xuXHRcdGxpdmVNYXAgPSB0cnVlO1xuXHR9XG59O1xuXG5jb25zdCBmaWxsUmVzdGF1cmFudHNIVE1MID0gKHJlc3RhdXJhbnRzID0gc2VsZi5yZXN0YXVyYW50cykgPT4ge1xuXHRjb25zdCB1bCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50cy1saXN0Jyk7XG5cdHJlc3RhdXJhbnRzLmZvckVhY2gocmVzdGF1cmFudCA9PiB7XG5cdFx0dWwuYXBwZW5kKGNyZWF0ZVJlc3RhdXJhbnRIVE1MKHJlc3RhdXJhbnQpKTtcblx0fSk7XG5cdFxuXHQvKiBMb2FkcyBhIHN0YXRpYyBtYXAgaW1hZ2UgaWYgaXQncyB0aGUgaW5pdGlhbCBwYWdlIGxvYWQuIEFkZHMgYSBjbGljayBldmVudCBsaXN0ZW5lciBzbyB0aGF0IHdoZW4gdGhlIHVzZXIgY2xpY2tzIG9uIHRoZSBtYXAsIGl0IHJlbW92ZXMgdGhlIHN0YXRpYyBtYXAgaW1hZ2UgYW5kIGxvYWRzIGEgbGl2ZSBtYXAgaW4gaXRzIHBsYWNlLiAqL1xuXHRpZiAoaW5pdExvYWQpe1xuXHRcdGZldGNoTmVpZ2hib3Job29kcygpO1xuXHRcdGZldGNoQ3Vpc2luZXMoKTtcblx0XHRjb25zdCBzdGF0aWNNYXAgPSBEQkhlbHBlci5zdGF0aWNJbWFnZUZvck1hcEluZGV4KHNlbGYucmVzdGF1cmFudHMpO1xuXHRcdGNvbnN0IG1hcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXAnKTtcblx0XHRjb25zdCBzdGF0aWNNYXBJbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTtcblx0XHRzdGF0aWNNYXBJbWcuaWQgPSAnc3RhdGljLW1hcC1pbWcnO1xuXHRcdHN0YXRpY01hcEltZy5hbHQgPSAnU3RhdGljIEdvb2dsZSBNYXBzIGltYWdlJztcblx0XHRzdGF0aWNNYXBJbWcuc3R5bGUud2lkdGggPSBgJHttYXAuY2xpZW50V2lkdGh9cHhgO1xuXHRcdHN0YXRpY01hcEltZy5zdHlsZS5oZWlnaHQgPSBgJHttYXAuY2xpZW50SGVpZ2h0fXB4YDtcblx0XHRzdGF0aWNNYXBJbWcuc3JjID0gc3RhdGljTWFwO1xuXHRcdHN0YXRpY01hcEltZy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcblx0XHRcdGdldExpdmVNYXAoKTtcblx0XHR9KTtcblx0XHRtYXAuYXBwZW5kQ2hpbGQoc3RhdGljTWFwSW1nKTtcblx0XHRpbml0TG9hZCA9IGZhbHNlO1xuXHR9IGVsc2Uge1xuXHRcdGFkZE1hcmtlcnNUb01hcCgpO1xuXHR9XG59O1xuXG4vKipcbiAqIENyZWF0ZSByZXN0YXVyYW50IEhUTUwuXG4gKi9cbmNvbnN0IGNyZWF0ZVJlc3RhdXJhbnRIVE1MID0gKHJlc3RhdXJhbnQpID0+IHtcblx0LyogTGF6eSBsb2FkcyBzbWFsbCBvciBsYXJnZSB2ZXJzaW9uIG9mIHJlc3RhdXJhbnQgaW1hZ2UgYmFzZWQgb24gZGF0YS1zcmNzZXQgYW5kIGF1dG8gZGF0YS1zaXplcy4gQWxzbyBkeW5hbWljYWxseSBzZXRzIGFsdCBhbmQgdGl0bGUgdGV4dCBvZiB0aGUgaW1hZ2UuICovXG5cdGNvbnN0IGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTsgXG5cdGNvbnN0IGltYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7XG5cdGltYWdlLmNsYXNzTmFtZSA9ICdyZXN0YXVyYW50LWltZyBsYXp5bG9hZCc7XG5cdGltYWdlLnNldEF0dHJpYnV0ZSgnZGF0YS1zcmMnLCBgJHtEQkhlbHBlci5zbWFsbEltYWdlVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KX0gNDAwd2ApO1xuXHRpbWFnZS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3Jjc2V0JyxgJHtEQkhlbHBlci5zbWFsbEltYWdlVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KX0gNDAwdywgJHtEQkhlbHBlci5sYXJnZUltYWdlVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KX0gODAwd2ApO1xuXHRpbWFnZS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc2l6ZXMnLCAnYXV0bycpO1xuXHRpbWFnZS50aXRsZSA9IGAke3Jlc3RhdXJhbnQubmFtZX1gO1xuXHRpbWFnZS5hbHQgPSBgJHtyZXN0YXVyYW50Lm5hbWV9IGluICR7cmVzdGF1cmFudC5uZWlnaGJvcmhvb2R9IC0gJHtyZXN0YXVyYW50LmN1aXNpbmVfdHlwZX0gcmVzdGF1cmFudGA7XG5cdGxpLmFwcGVuZENoaWxkKGltYWdlKTtcblxuXHQvKiBDcmVhdGVzIGhlYWRlciBkaXYgdG8gaG9sZCBuYW1lICYgZmF2b3JpdGUgYnV0dG9uLiAqL1xuXHRjb25zdCBoZWFkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblx0aGVhZGVyLmlkID0gXCJoZWFkZXJcIjtcblx0bGkuYXBwZW5kQ2hpbGQoaGVhZGVyKTtcblxuXHRjb25zdCBuYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaDMnKTtcblx0bmFtZS5pbm5lckhUTUwgPSByZXN0YXVyYW50Lm5hbWU7XG5cdGhlYWRlci5hcHBlbmRDaGlsZChuYW1lKTtcblxuXHQvKiBDcmVhdGVzIGZhdm9yaXRlIGJ1dHRvbiAqL1xuXHRjcmVhdGVGYXZvcml0ZUJ1dHRvbihyZXN0YXVyYW50LCBoZWFkZXIpO1xuXG5cdGNvbnN0IG5laWdoYm9yaG9vZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcblx0bmVpZ2hib3Job29kLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmVpZ2hib3Job29kO1xuXHRsaS5hcHBlbmRDaGlsZChuZWlnaGJvcmhvb2QpO1xuXG5cdGNvbnN0IGFkZHJlc3MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XG5cdGFkZHJlc3MuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5hZGRyZXNzO1xuXHRsaS5hcHBlbmRDaGlsZChhZGRyZXNzKTtcblxuXHQvKiBDcmVhdGVzIGVtcHR5IGVsZW1lbnQgc28gZmxleCBncm93IGNhbiBiZSBhcHBsaWVkIGFuZCBjcmVhdGUgc3BhY2UgdG8gdmVydGljYWxseSBhbGlnbiBWaWV3IERldGFpbHMgYnV0dG9ucy4gKi9cblx0Y29uc3QgZW1wdHkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XG5cdGVtcHR5LmNsYXNzTmFtZSA9ICdyZXN0YXVyYW50LWVtcHR5Jztcblx0bGkuYXBwZW5kQ2hpbGQoZW1wdHkpO1xuXG5cdGNvbnN0IG1vcmUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XG5cdG1vcmUuaW5uZXJIVE1MID0gJ1ZpZXcgUmVzdGF1cmFudCBEZXRhaWxzJztcblx0bW9yZS5ocmVmID0gREJIZWxwZXIudXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KTtcblxuXHQvKiBEeW5hbWljYWxseSBzZXRzIHRpdGxlIGF0dHJpYnV0ZS4gKi9cblx0bW9yZS50aXRsZSA9IGAke3Jlc3RhdXJhbnQubmFtZX0gLSBWaWV3IFJlc3RhdXJhbnQgRGV0YWlsc2A7XG5cblx0LyogU2V0cyBBUklBIGF0dHJpYnV0ZXMgdG8gZWFjaCByZXN0YXVyYW50IGxpbmsuICovXG5cdG1vcmUuc2V0QXR0cmlidXRlKCdyb2xlJywgJ2J1dHRvbicpO1xuXHRtb3JlLnNldEF0dHJpYnV0ZSgndGFiaW5kZXgnLCAnMCcpO1xuXHRtb3JlLnNldEF0dHJpYnV0ZSgnYXJpYS1sYWJlbCcsICdWaWV3JyArIHJlc3RhdXJhbnQubmFtZSArICdSZXN0YXVyYW50IERldGFpbHMnKTtcblx0bGkuYXBwZW5kQ2hpbGQobW9yZSk7XG5cblx0cmV0dXJuIGxpO1xufTtcblxuLyoqXG4gKiBDcmVhdGVzIGEgZmF2b3JpdGUgYnV0dG9uLiBXaGVuIGNsaWNrZWQsIG5vdGlmaWVzIHVzZXIgdGhhdCByZXN0YXVyYW50IGZhdm9yaXRlIGhhcyBiZWVuIGFkZGVkIG9yIHJlbW92ZWQgdmlhIHZpc3VhbCBjdWVzIGFuZCBBUklBIGxhYmVsIGNoYW5nZXMuIEFsc28gdXBkYXRlcyBzZXJ2ZXIgYW5kIEluZGV4ZWREQiB3aXRoIGZhdm9yaXRlIHN0YXR1cyBvZiB0aGUgcmVzdGF1cmFudC4gSWYgdXNlciBjbGlja3Mgb24gZmF2b3JpdGUgYnV0dG9uIHdoaWxlIG9mZmxpbmUsIHN0b3JlcyBmYXZvcml0ZSBzdGF0dXMgaW4gbG9jYWwgc3RvcmFnZSBhbmQgY3JlYXRlcyBhbiBvZmZsaW5lIGxhYmVsIHRvIG5vdGlmeSB1c2VyIGZhdm9yaXRlIHN0YXR1cyB3aWxsIGJlIHVwZGF0ZWQgd2hlbiBuZXR3b3JrIGNvbm5lY3Rpb24gaXMgcmVlc3RhYmxpc2hlZC4gXG4gKi9cbmNvbnN0IGNyZWF0ZUZhdm9yaXRlQnV0dG9uID0gKHJlc3RhdXJhbnQsIGhlYWRlcikgPT4ge1xuXHRjb25zdCBmYXZvcml0ZUJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpO1xuXHRmYXZvcml0ZUJ1dHRvbi50eXBlID0gJ2J1dHRvbic7XG5cdGZhdm9yaXRlQnV0dG9uLmlkID0gJ2Zhdm9yaXRlLWJ1dHRvbic7XG5cdGNvbnN0IHJlc3RhdXJhbnRJZCA9IHJlc3RhdXJhbnQuaWQ7XG5cdGxldCBpc0Zhdm9yaXRlID0gcmVzdGF1cmFudC5pc19mYXZvcml0ZTtcblx0bGV0IG5vT2ZmbGluZUxhYmVsID0gdHJ1ZTtcblxuXHRjaGFuZ2VGYXZvcml0ZUJ1dHRvbihpc0Zhdm9yaXRlLCBmYXZvcml0ZUJ1dHRvbik7XG5cblx0ZmF2b3JpdGVCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG5cdFx0aWYoIW5hdmlnYXRvci5vbkxpbmUpe1xuXHRcdFx0aWYgKGlzRmF2b3JpdGUgPT09ICdmYWxzZScpe1xuXHRcdFx0XHRpc0Zhdm9yaXRlID0gJ3RydWUnO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0aXNGYXZvcml0ZSA9ICdmYWxzZSc7XG5cdFx0XHR9XG5cdFx0XHQvKiBDcmVhdGVzIHVuaXF1ZSBpZCB0byByZWZlcmVuY2UgZmF2b3JpdGUgc3RhdHVzIGluIGxvY2FsIHN0b3JhZ2UuICovXG5cdFx0XHRvZmZsaW5lRmF2b3JpdGVDb3VudGVyKys7XG5cdFx0XHRsZXQgZmF2b3JpdGVJZCA9IG9mZmxpbmVGYXZvcml0ZUNvdW50ZXIudG9TdHJpbmcoKTtcblx0XHRcdC8qIE1ha2Ugc3VyZSBvbmx5IG9uZSBvZmZsaW5lIGxhYmVsIGlzIGNyZWF0ZWQgbm8gbWF0dGVyIGhvdyBtYW55IHRpbWVzIHVzZXIgY2xpY2tzIG9uIGZhdm9yaXRlIGJ1dHRvbiB3aGlsZSBvZmZsaW5lICovXG5cdFx0XHRpZihub09mZmxpbmVMYWJlbCl7XG5cdFx0XHRcdGNvbnN0IG9mZmxpbmVGYXZvcml0ZUxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cdFx0XHRcdG9mZmxpbmVGYXZvcml0ZUxhYmVsLmNsYXNzTGlzdC5hZGQoJ29mZmxpbmUtZmF2b3JpdGUtbGFiZWwnKTtcblx0XHRcdFx0b2ZmbGluZUZhdm9yaXRlTGFiZWwuaW5uZXJIVE1MID0gYDxpIGNsYXNzPVwiZmFzIGZhLWV4Y2xhbWF0aW9uLXRyaWFuZ2xlXCI+PC9pPiBPZmZsaW5lIE1vZGUgLSBGYXZvcml0ZSBzdGF0dXMgd2lsbCBzdWJtaXQgd2hlbiBuZXR3b3JrIGNvbm5lY3Rpb24gaXMgcmVlc3RhYmxpc2hlZGA7XG5cdFx0XHRcdGhlYWRlci5wYXJlbnROb2RlLmluc2VydEJlZm9yZShvZmZsaW5lRmF2b3JpdGVMYWJlbCwgaGVhZGVyKTtcblx0XHRcdFx0bm9PZmZsaW5lTGFiZWwgPSBmYWxzZTtcblx0XHRcdH1cblx0XHRcdERCSGVscGVyLnVwZGF0ZUZhdm9yaXRlKGZhdm9yaXRlSWQsIHJlc3RhdXJhbnRJZCwgaXNGYXZvcml0ZSk7XG5cdFx0XHRyZXN0YXVyYW50LmlzX2Zhdm9yaXRlID0gaXNGYXZvcml0ZTtcblx0XHRcdGNoYW5nZUZhdm9yaXRlQnV0dG9uKGlzRmF2b3JpdGUsIGZhdm9yaXRlQnV0dG9uKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0aWYgKGlzRmF2b3JpdGUgPT09ICdmYWxzZScpe1xuXHRcdFx0aXNGYXZvcml0ZSA9ICd0cnVlJztcblx0XHR9IGVsc2Uge1xuXHRcdFx0aXNGYXZvcml0ZSA9ICdmYWxzZSc7XG5cdFx0fSBcblx0XHREQkhlbHBlci51cGRhdGVGYXZvcml0ZShudWxsLCByZXN0YXVyYW50SWQsIGlzRmF2b3JpdGUpO1xuXHRcdHJlc3RhdXJhbnQuaXNfZmF2b3JpdGUgPSBpc0Zhdm9yaXRlO1xuXHRcdGNoYW5nZUZhdm9yaXRlQnV0dG9uKGlzRmF2b3JpdGUsIGZhdm9yaXRlQnV0dG9uKTtcblx0fSk7XG5cdGhlYWRlci5hcHBlbmRDaGlsZChmYXZvcml0ZUJ1dHRvbik7XG59O1xuXG4vKipcbiAqIENoYW5nZSBmYXZvcml0ZSBidXR0b24gdG8gYXBwZWFyIG9uIG9yIG9mZiB3aXRoIGNsYXNzIGNoYW5nZS5cbiAqL1xuY29uc3QgY2hhbmdlRmF2b3JpdGVCdXR0b24gPSAoaXNGYXZvcml0ZSwgZmF2b3JpdGVCdXR0b24pID0+IHtcblx0aWYgKGlzRmF2b3JpdGUgPT09ICd0cnVlJyl7XG5cdFx0ZmF2b3JpdGVCdXR0b24udGl0bGUgPSAnUmVtb3ZlIGZyb20gZmF2b3JpdGVzJztcblx0XHRmYXZvcml0ZUJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2FyaWEtbGFiZWwnLCAnUmVtb3ZlIGZyb20gZmF2b3JpdGVzJyk7XG5cdFx0ZmF2b3JpdGVCdXR0b24uY2xhc3NMaXN0LmFkZCgnaW5kZXgtZmF2b3JpdGUtdHJ1ZScpO1xuXHRcdGZhdm9yaXRlQnV0dG9uLmNsYXNzTGlzdC5yZW1vdmUoJ2luZGV4LWZhdm9yaXRlLWZhbHNlJyk7XG5cdFx0ZmF2b3JpdGVCdXR0b24uaW5uZXJIVE1MID0gJzxpIGNsYXNzPVwiZmFzIGZhLWhlYXJ0XCI+PC9pPic7XG5cdH0gZWxzZSB7XG5cdFx0ZmF2b3JpdGVCdXR0b24udGl0bGUgPSAnQWRkIHRvIGZhdm9yaXRlcyc7XG5cdFx0ZmF2b3JpdGVCdXR0b24uc2V0QXR0cmlidXRlKCdhcmlhLWxhYmVsJywgJ0FkZCB0byBmYXZvcml0ZXMnKTtcblx0XHRmYXZvcml0ZUJ1dHRvbi5jbGFzc0xpc3QuYWRkKCdpbmRleC1mYXZvcml0ZS1mYWxzZScpO1xuXHRcdGZhdm9yaXRlQnV0dG9uLmNsYXNzTGlzdC5yZW1vdmUoJ2luZGV4LWZhdm9yaXRlLXRydWUnKTtcblx0XHRmYXZvcml0ZUJ1dHRvbi5pbm5lckhUTUwgPSAnPGkgY2xhc3M9XCJmYXIgZmEtaGVhcnRcIj48L2k+Jztcblx0fVxufTtcblxuLyoqXG4gKiBBZGQgbWFya2VycyBmb3IgY3VycmVudCByZXN0YXVyYW50cyB0byB0aGUgbWFwLlxuICovXG5jb25zdCBhZGRNYXJrZXJzVG9NYXAgPSAocmVzdGF1cmFudHMgPSBzZWxmLnJlc3RhdXJhbnRzKSA9PiB7XG5cdHJlc3RhdXJhbnRzLmZvckVhY2gocmVzdGF1cmFudCA9PiB7XG5cdFx0Ly8gQWRkIG1hcmtlciB0byB0aGUgbWFwXG5cdFx0Y29uc3QgbWFya2VyID0gREJIZWxwZXIubWFwTWFya2VyRm9yUmVzdGF1cmFudChyZXN0YXVyYW50LCBzZWxmLm1hcCk7XG5cdFx0Z29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIobWFya2VyLCAnY2xpY2snLCAoKSA9PiB7XG5cdFx0XHR3aW5kb3cubG9jYXRpb24uaHJlZiA9IG1hcmtlci51cmw7XG5cdFx0fSk7XG5cdFx0c2VsZi5tYXJrZXJzLnB1c2gobWFya2VyKTtcblx0fSk7XG59O1xuXG4iXX0=
